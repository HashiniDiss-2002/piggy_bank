<!DOCTYPE html>
<html>
<head>
  <title>üê∑ Piggy Bank - Saving Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: rgb(223, 106, 125);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .card {
      background-color: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      text-align: center;
      width: 350px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .card input,
    .card select {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    .card button {
      width: 40%;
      padding: 10px;
      margin: 10px 5px 0 5px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      color: white;
    }

    .card button.login-btn {
      background-color: rgb(223, 106, 125);
    }

    .card button.signup-btn {
      background-color: rgb(100, 181, 246);
    }

    .hidden {
      display: none;
    }

    h3 {
      margin-top: 25px;
      color: #333;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    ul li {
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
  </style>
</head>
<body>

<!-- Auth Section -->
<div id="auth-section" class="card">
  <h1>Piggy Bank</h1>
  <h2>Login / Signup</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button class="login-btn" onclick="login()">Login</button>
  <button class="signup-btn" onclick="signup()">Signup</button>
</div>

<!-- Dashboard -->
<div id="dashboard" class="card hidden">
  <h1>Piggy Bank Dashboard</h1>
  <button class="login-btn" onclick="logout()">Logout</button>

  <h3>Categories</h3>
  <ul id="category-list"></ul>
  <input type="text" id="new-category" placeholder="New Category">
  <button class="signup-btn" onclick="addCategory()">Add Category</button>

  <h3>Add Expense</h3>
  <input type="text" id="expense-name" placeholder="Expense Name">
  <input type="number" id="expense-amount" placeholder="Amount">
  <select id="category-select"></select>
  <button class="signup-btn" onclick="addExpense()">Add Expense</button>

  <h3>Expenses History</h3>
  <ul id="expense-list"></ul>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDoc,
    getDocs,
    doc,
    updateDoc,
    serverTimestamp,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB03PiDFmzdKIGJsl9mBdSqjqcYQallUTk",
    authDomain: "piggybank-da942.firebaseapp.com",
    projectId: "piggybank-da942",
    storageBucket: "piggybank-da942.appspot.com",
    messagingSenderId: "270202155163",
    appId: "1:270202155163:web:09e87be83fecc7fdbe163e",
    measurementId: "G-B8QG7CDZ8J"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const authSection = document.getElementById("auth-section");
  const dashboard = document.getElementById("dashboard");
  const categoryList = document.getElementById("category-list");
  const categorySelect = document.getElementById("category-select");
  const expenseList = document.getElementById("expense-list");

  // Authentication
  async function signup() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) {
      alert("Signup Error: " + err.message);
    }
  }

  async function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      alert("Login Error: " + err.message);
    }
  }

  async function logout() {
    await signOut(auth);
  }

  onAuthStateChanged(auth, (user) => {
    if (user) {
      authSection.classList.add("hidden");
      dashboard.classList.remove("hidden");
      loadCategories();
      loadExpenses();
    } else {
      authSection.classList.remove("hidden");
      dashboard.classList.add("hidden");
    }
  });

  // Categories
  async function loadCategories() {
    categoryList.innerHTML = "";
    categorySelect.innerHTML = "<option value=''>No Category</option>";

    try {
      const snap = await getDocs(collection(db, "users", auth.currentUser.uid, "categories"));
      snap.forEach(docSnap => {
        const c = docSnap.data();
        categoryList.innerHTML += `<li>${c.name} - $${c.current_amount ?? 0}</li>`;
        categorySelect.innerHTML += `<option value="${docSnap.id}">${c.name}</option>`;
      });
    } catch (err) {
      console.error("Error loading categories:", err);
    }
  }

  async function addCategory() {
    const name = document.getElementById("new-category").value.trim();
    if (!name) return alert("Enter a category name.");
    try {
      await addDoc(collection(db, "users", auth.currentUser.uid, "categories"), {
        name,
        current_amount: 0,
        created_at: serverTimestamp()
      });
      document.getElementById("new-category").value = "";
      loadCategories();
    } catch (err) {
      console.error("Add Category Error:", err);
    }
  }

  // Expenses
  async function loadExpenses() {
    expenseList.innerHTML = "";
    try {
      const q = query(collection(db, "users", auth.currentUser.uid, "expenses"), orderBy("created_at", "desc"));
      const snap = await getDocs(q);
      snap.forEach(docSnap => {
        const e = docSnap.data();
        const categoryName = categorySelect.querySelector(`option[value='${e.categoryId}']`)?.text || "No Category";
        expenseList.innerHTML += `<li>${e.name} - $${e.amount} (${categoryName})</li>`;
      });
    } catch (err) {
      console.error("Load Expenses Error:", err);
    }
  }

  async function addExpense() {
    const name = document.getElementById("expense-name").value.trim();
    const amount = parseFloat(document.getElementById("expense-amount").value);
    const categoryId = document.getElementById("category-select").value;

    if (!name || isNaN(amount)) return alert("Enter valid expense name and amount.");

    try {
      await addDoc(collection(db, "users", auth.currentUser.uid, "expenses"), {
        name,
        amount,
        categoryId: categoryId || null,
        created_at: serverTimestamp()
      });

      if (categoryId) {
        const catRef = doc(db, "users", auth.currentUser.uid, "categories", categoryId);
        const catSnap = await getDoc(catRef);
        const catData = catSnap.data();
        await updateDoc(catRef, {
          current_amount: (catData.current_amount || 0) - amount
        });
      }

      // Clear form
      document.getElementById("expense-name").value = "";
      document.getElementById("expense-amount").value = "";
      document.getElementById("category-select").value = "";

      loadCategories();
      loadExpenses();
    } catch (err) {
      console.error("Add Expense Error:", err);
    }
  }
</script>

</body>
</html>

